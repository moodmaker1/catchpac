rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // 관리자 체크 함수
    function isAdmin() {
      return request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.isAdmin == true;
    }

    // Users collection
    match /users/{userId} {
      // 판매자(SELLER) 정보는 공개적으로 읽을 수 있음 (업체 목록 표시용)
      // 개인 정보는 자신만 읽을 수 있음
      // 관리자는 모든 사용자 정보 읽기 가능
      allow read: if request.auth != null || 
        (resource != null && resource.data.userType == 'SELLER') ||
        isAdmin();
      // 자신의 문서만 생성 가능
      allow create: if request.auth != null && request.auth.uid == userId;
      // 자신의 문서 수정 가능 또는 관리자는 모든 사용자 수정 가능
      allow update: if request.auth != null && 
        (request.auth.uid == userId || isAdmin());
      // 관리자만 삭제 가능
      allow delete: if isAdmin();
    }
    
    // Quote Requests collection
    match /quoteRequests/{requestId} {
      // 공개적으로 읽을 수 있음 (시세 정보 표시용)
      allow read: if true;
      // 구매자만 생성 가능
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'BUYER';
      // 작성자만 수정 가능
      allow update: if request.auth != null && 
        resource.data.buyerId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.buyerId == request.auth.uid;
    }
    
    // Quote Responses collection
    match /quoteResponses/{responseId} {
      // 시세 정보 표시를 위해 공개적으로 읽을 수 있음 (가격, 납기 정보만)
      // 전체 데이터는 인증된 사용자만
      allow read: if true; // 공개 읽기 허용 (시세 정보 표시용)
      // 판매자만 생성 가능
      allow create: if request.auth != null && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.userType == 'SELLER';
      // 작성자만 수정 가능
      allow update: if request.auth != null && 
        resource.data.sellerId == request.auth.uid;
      allow delete: if request.auth != null && 
        resource.data.sellerId == request.auth.uid;
    }
  }
}
